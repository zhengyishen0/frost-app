name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for commit count

      - name: Set version from tag
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          BUILD_NUMBER=$(git rev-list --count HEAD)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "Setting version to $VERSION (build $BUILD_NUMBER)"

          # Update Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" Frost/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" Frost/Info.plist

      - name: Install certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Decode certificate
          echo -n "$CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          security import $CERTIFICATE_PATH -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

      - name: Build and Archive
        run: |
          xcodebuild clean archive \
            -scheme Frost \
            -configuration Release \
            -archivePath build/Frost.xcarchive \
            CODE_SIGN_IDENTITY="Developer ID Application: Zhengyi Shen (L926GNJA8S)" \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM=L926GNJA8S

      - name: Notarize app
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          TEAM_ID: L926GNJA8S
        run: |
          # Create zip for notarization
          ditto -c -k --keepParent build/Frost.xcarchive/Products/Applications/Frost.app build/Frost.zip

          # Submit for notarization
          xcrun notarytool submit build/Frost.zip \
            --apple-id "$APPLE_ID" \
            --team-id "$TEAM_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --wait

          # Staple the ticket
          xcrun stapler staple build/Frost.xcarchive/Products/Applications/Frost.app

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: |
          create-dmg \
            --volname "Frost" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "Frost.app" 150 185 \
            --app-drop-link 450 185 \
            "Frost-${{ env.VERSION }}.dmg" \
            "build/Frost.xcarchive/Products/Applications/Frost.app"

      - name: Sign and Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          TEAM_ID: L926GNJA8S
        run: |
          # Sign DMG
          codesign --force --sign "Developer ID Application: Zhengyi Shen (L926GNJA8S)" "Frost-${{ env.VERSION }}.dmg"

          # Notarize DMG
          xcrun notarytool submit "Frost-${{ env.VERSION }}.dmg" \
            --apple-id "$APPLE_ID" \
            --team-id "$TEAM_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --wait

          # Staple DMG
          xcrun stapler staple "Frost-${{ env.VERSION }}.dmg"

      - name: Calculate DMG SHA256
        run: |
          SHA256=$(shasum -a 256 "Frost-${{ env.VERSION }}.dmg" | cut -d ' ' -f 1)
          echo "SHA256=$SHA256" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: Frost-${{ env.VERSION }}.dmg
          body: |
            ## Frost ${{ env.VERSION }}

            **Focus on what matters.**

            ### Installation

            **Download**
            1. Download `Frost-${{ env.VERSION }}.dmg`
            2. Open the DMG and drag Frost to Applications
            3. Launch Frost from Applications

            **Homebrew**
            ```bash
            brew install --cask zhengyishen0/frost/frost
            ```

            ### Requirements
            - macOS 14.0 (Sonoma) or later
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew Cask
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/zhengyishen0/homebrew-frost.git
          cd homebrew-frost

          cat > Casks/frost.rb << EOF
          cask "frost" do
            version "${VERSION}"
            sha256 "${SHA256}"

            url "https://github.com/zhengyishen0/frost-app/releases/download/v#{version}/Frost-#{version}.dmg"
            name "Frost"
            desc "Focus on what matters - blur distractions"
            homepage "https://github.com/zhengyishen0/frost-app"

            depends_on macos: ">= :sonoma"

            app "Frost.app"

            zap trash: [
              "~/Library/Preferences/com.example.frost.plist",
              "~/Library/Application Support/Frost",
            ]
          end
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/frost.rb
          git commit -m "Update Frost to v${VERSION}"
          git push
